name: immortalwrt_x86_R25_12

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "ssh"
        required: false
        default: "false"

env:
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: æ„å»ºå›ºä»¶ - ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [immortalwrt_r25]

    steps:
      - name: ğŸ§¹ æ¸…ç†ç£ç›˜ç©ºé—´
        uses: sbwml/actions@free-disk

      - name: ğŸ§± åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo -E apt -yqq install dos2unix
          sudo -E apt -yqq install libfuse-dev
          sudo -E apt -yqq autoremove --purge
          sudo -E apt -yqq autoclean
          sudo -E apt -yqq clean
          sudo -E systemctl daemon-reload
          sudo timedatectl set-timezone "$TZ"

      - name: ğŸ§¾ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“… è·å–å½“å‰æ—¶é—´
        id: date
        run: |
          echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
          echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
          echo "VERSION=$(date +'%m.%d')" >> $GITHUB_ENV

      - name: ğŸ“¦ å…‹éš†æºä»£ç 
        env:
          REPO_URL: https://github.com/immortalwrt/immortalwrt
          REPO_BRANCH: openwrt-25.12
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: ğŸ”„ æ›´æ–°Feeds
        working-directory: ./openwrt
        run: |
          echo "ğŸ“ æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶æºåˆ° feeds.conf.default..."
          echo "src-git nikki https://github.com/nikkinikki-org/OpenWrt-nikki.git;main" >> feeds.conf.default

          echo "ğŸ“¦ å…‹éš†è‡ªå®šä¹‰åŒ…ä»“åº“ï¼ˆlucky ä½œä¸ºæœ¬åœ°åŒ…ï¼‰..."
          git clone --depth 1 https://github.com/gdy666/luci-app-lucky.git package/lucky || {
            echo "âŒ lucky ä»“åº“å…‹éš†å¤±è´¥"
            exit 1
          }

          echo "ğŸ”„ æ›´æ–°è½¯ä»¶æºï¼ˆåŒ…æ‹¬æ–°æ·»åŠ çš„ nikki feedï¼‰..."
          ./scripts/feeds update -a || {
            echo "âŒ è½¯ä»¶æºæ›´æ–°å¤±è´¥ï¼Œé‡è¯•ä¸€æ¬¡..."
            sleep 5
            ./scripts/feeds update -a
          }

          echo "ğŸ“¦ å®‰è£…æ‰€æœ‰è½¯ä»¶åŒ…..."
          ./scripts/feeds install -a || {
            echo "âš ï¸ æ‰¹é‡å®‰è£…å¤±è´¥ï¼Œå°è¯•é€ä¸ªå®‰è£…æ ¸å¿ƒåŒ…..."
            ./scripts/feeds install -p packages -a
            ./scripts/feeds install -p luci -a
            echo "âœ… æ ¸å¿ƒåŒ…å®‰è£…å®Œæˆ"
          }

          echo "ğŸ“¦ å•ç‹¬å®‰è£… nikki feed åŒ…ï¼ˆç¡®ä¿å®‰è£…ï¼‰..."
          ./scripts/feeds install -p nikki -a || {
            echo "âš ï¸ nikki feed å®‰è£…å¤±è´¥ï¼Œä½†ä¸ä¸­æ–­æ„å»º"
          }

      - name: ğŸ›  ä¿®æ”¹é»˜è®¤é…ç½®
        working-directory: ./openwrt
        run: |
          sed -i 's/192.168.1.1/10.159.1.66/g' package/base-files/files/bin/config_generate
          sed -i 's/ImmortalWrt/LuckyWRT/g' package/base-files/files/bin/config_generate

      - name: âš™ï¸ åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          CONFIG_FILE="${{matrix.target}}.config"
          if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… å‘ç°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            cp "$CONFIG_FILE" openwrt/.config
          else
            echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            exit 1
          fi

      - name: ğŸ“‹ åº”ç”¨é…ç½®ï¼ˆmake defconfigï¼‰
        working-directory: ./openwrt
        run: |
          make defconfig
          echo "ğŸ“‚ æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
          head -n 20 .config

      - name: ğŸ§© ç¼–è¯‘å›ºä»¶
        working-directory: ./openwrt
        run: |
          echo "ğŸ“Š ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼ˆ$(nproc) æ ¸å¿ƒçº¿ç¨‹ï¼‰..."
          make -j$(nproc) || {
            echo "âš ï¸ å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œåˆ‡æ¢åˆ°å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼..."
            echo "ğŸ“Š å½“å‰ç£ç›˜ç©ºé—´ï¼š"
            df -h
            echo "ğŸ“‹ å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘å¹¶è¾“å‡ºè¯¦ç»†æ—¥å¿—..."
            make -j1 V=s
          }

      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘æ—¥å¿—ï¼ˆå¦‚æœå¤±è´¥ï¼‰
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: build-logs-${{ env.date3 }}-${{matrix.target}}
          path: |
            openwrt/build.log
            openwrt/build_verbose.log
            openwrt/.config
          retention-days: 7

      - name: ğŸ“‚ æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir firmware
          mv -f openwrt/bin/targets/*/*/{*combined*,*sysupgrade*} ./firmware/ 2>/dev/null || true
          if [ -f openwrt/.config ]; then
            cp openwrt/.config ./firmware/${{matrix.target}}.config
          else
            echo "âš ï¸ è­¦å‘Šï¼šæœªæ‰¾åˆ° openwrt/.config æ–‡ä»¶ï¼Œè·³è¿‡é…ç½®æ–‡ä»¶ä¿å­˜"
          fi
          cd firmware
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: â˜ï¸ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ${{ env.date3 }} _${{matrix.target}}
          path: ${{ env.FIRMWARE }}

      - name: ğŸ· ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          touch release.txt
          echo "OpenWrt firmware for ${{matrix.target}}" >> release.txt
          echo "Build date: ${{ env.date2 }}" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v1
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          files: "${{ env.FIRMWARE }}/*"
          name: ${{ env.date2 }} ${{matrix.target}}
          tag_name: ${{ env.date }}_${{matrix.target}}
          body_path: release.txt

      - name: ğŸ§¹ åˆ é™¤æ—§çš„ Workflow è®°å½•
        uses: Mattraks/delete-workflow-runs@v2
        with:
          retain_days: 1
          keep_minimum_runs: 0

      - name: ğŸ—‘ æ¸…ç†æ—§çš„ Release
        uses: dev-drprasad/delete-older-releases@v0.3.0
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 6
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
