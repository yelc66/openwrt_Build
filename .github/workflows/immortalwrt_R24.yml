name: immortalwrt_x86_R24_10

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: "ssh"
        required: false
        default: "false"

env:
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: Ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    name: æ„å»ºå›ºä»¶ - ${{matrix.target}}
    strategy:
      fail-fast: false
      matrix:
        target: [immortalwrt-r24]

    steps:
      - name: ğŸ§¾ æ‹‰å–ä»£ç 
        uses: actions/checkout@main

      - name: ğŸ§± åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libfuse-dev libglib2.0-dev libgmp3-dev libltdl-dev libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libpython3-dev libreadline-dev libssl-dev libtool lrzsz mkisofs msmtp ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pyelftools python3-setuptools qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev rename
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"

      - name: ğŸ“… è·å–å½“å‰æ—¶é—´
        id: date
        run: |
          echo "date=$(date +'%Y.%m.%d-%H%M')" >> $GITHUB_ENV
          echo "date2=$(date +'%m/%d %Y')" >> $GITHUB_ENV
          echo "date3=$(date +'%m.%d')" >> $GITHUB_ENV
          echo "VERSION=$(date +'%m.%d')" >> $GITHUB_ENV

      - name: ğŸ“¦ å…‹éš†æºä»£ç 
        env:
          REPO_URL: https://github.com/immortalwrt/immortalwrt
          REPO_BRANCH: openwrt-24.10
        run: |
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt

      - name: ğŸ”„ æ›´æ–°Feeds
        working-directory: ./openwrt
        run: |
          git clone https://github.com/gdy666/luci-app-lucky.git package/lucky
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: ğŸ›  ä¿®æ”¹é»˜è®¤é…ç½®
        working-directory: ./openwrt
        run: |
          sed -i 's/192.168.1.1/10.159.1.66/g' package/base-files/files/bin/config_generate
          sed -i 's/ImmortalWrt/LuckyWRT/g' package/base-files/files/bin/config_generate

      - name: âš™ï¸ åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          CONFIG_FILE="${{matrix.target}}.config"
          if [ -f "$CONFIG_FILE" ]; then
            echo "âœ… å‘ç°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            cp "$CONFIG_FILE" openwrt/.config
          else
            echo "âŒ æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ï¼š$CONFIG_FILE"
            exit 1
          fi

      - name: ğŸ“‹ åº”ç”¨é…ç½®ï¼ˆmake defconfigï¼‰
        working-directory: ./openwrt
        run: |
          make defconfig
          echo "ğŸ“‚ æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š"
          head -n 20 .config

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        working-directory: ./openwrt
        run: |
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: ğŸ§© ç¼–è¯‘å›ºä»¶
        working-directory: ./openwrt
        run: |
          echo -e "$(($(nproc)+1)) çº¿ç¨‹è¿›è¡Œç¼–è¯‘"
          make -j$(($(nproc)+1)) || make -j1 V=s

      - name: ğŸ“‚ æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir firmware
          mv -f openwrt/bin/targets/*/*/{*combined*,*sysupgrade*} ./firmware/ 2>/dev/null || true
          cp openwrt/.config ./firmware/${{matrix.target}}.config
          cd firmware
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV

      - name: â˜ï¸ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@main
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: ${{ env.date3 }} _${{matrix.target}}
          path: ${{ env.FIRMWARE }}

      - name: ğŸ· ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        run: |
          touch release.txt
          echo "OpenWrt firmware for ${{matrix.target}}" >> release.txt
          echo "Build date: ${{ env.date2 }}" >> release.txt
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ğŸš€ ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@master
        if: steps.tag.outputs.status == 'success' && !cancelled()
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
        with:
          files: "${{ env.FIRMWARE }}/*"
          name: ${{ env.date2 }} ${{matrix.target}}
          tag_name: ${{ env.date }}_${{matrix.target}}
          body_path: release.txt

      - name: ğŸ§¹ åˆ é™¤æ—§çš„ Workflow è®°å½•
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 0

      - name: ğŸ—‘ æ¸…ç†æ—§çš„ Release
        uses: dev-drprasad/delete-older-releases@master
        if: env.UPLOAD_RELEASE == 'true' && !cancelled()
        with:
          keep_latest: 6
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.REPO_TOKEN }}
